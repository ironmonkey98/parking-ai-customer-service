<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸäººå®¢æœæ¥ç®¡æ§åˆ¶å°</title>
    <script src="https://g.alicdn.com/code/lib/aliyun-webrtc-sdk/1.12.13/index.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 50px; }
        .console-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .status-box { padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; }
        .status-idle { background: #e2e3e5; color: #383d41; }
        .status-connected { background: #d1e7dd; color: #0f5132; }
        .status-error { background: #f8d7da; color: #842029; }
        #remote-video { width: 100%; height: 200px; background: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="console-card">
                <h3 class="mb-4 text-center">ğŸ‘©â€ğŸ’¼ çœŸäººå®¢æœæ¥ç®¡å°</h3>
                
                <div id="status" class="status-box status-idle text-center">
                    ç­‰å¾…æ¥å…¥...
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted">å½“å‰é¢‘é“ (Channel ID)</label>
                    <input type="text" class="form-control" id="channelId" readonly>
                </div>

                <div id="remote-video" class="mb-4">
                    <span>â³ ç­‰å¾…å®¢æˆ·è¯­éŸ³æµ...</span>
                </div>

                <div class="d-grid gap-2">
                    <button id="btn-join" class="btn btn-primary btn-lg" onclick="startTakeover()">
                        ğŸ“ ç«‹å³æ¥å¬ (å…¥ä¼š)
                    </button>
                    <button id="btn-leave" class="btn btn-danger btn-lg" onclick="leaveCall()" disabled>
                        ğŸ“´ æŒ‚æ–­é€šè¯
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 2. åˆå§‹åŒ– AliRtcEngine
    const aliRtcEngine = new AliRtcEngine();
    
    // ä» URL è·å– FastGPT ä¼ è¿‡æ¥çš„å‚æ•°
    // URL ç¤ºä¾‹: https://your-domain.com/agent.html?token=xxx&channelId=123&userId=agent01&nonce=xxx&gslb=xxx...
    const urlParams = new URLSearchParams(window.location.search);
    
    // æ ¸å¿ƒå‚æ•°æ˜ å°„ (æ ¹æ® TakeoverAIAgentCall æ¥å£è¿”å›çš„å­—æ®µ)
    const authInfo = {
        appid: urlParams.get('appId') || 'æ‚¨çš„AppID', // å¦‚æœæ¥å£æ²¡è¿”å› AppIdï¼Œéœ€åœ¨æ­¤ç¡¬ç¼–ç 
        channel: urlParams.get('channelId'),
        userid: urlParams.get('userId'),
        token: urlParams.get('token'),
        nonce: urlParams.get('nonce'),
        gslb: urlParams.get('gslb') ? [urlParams.get('gslb')] : null, // gslb å¿…é¡»æ˜¯æ•°ç»„
        timestamp: parseInt(urlParams.get('timestamp'))
    };

    // è‡ªåŠ¨å¡«å……ç•Œé¢
    document.getElementById('channelId').value = authInfo.channel || 'æœªæ£€æµ‹åˆ°é¢‘é“å‚æ•°';

    // ---- æ ¸å¿ƒé€»è¾‘ A: ç›‘å¬äº‹ä»¶ ----
    
    // 1. ç›‘å¬è¿œç«¯ç”¨æˆ·(å®¢æˆ·)ä¸Šçº¿
    aliRtcEngine.on('remoteUserOnLineNotify', (userId) => {
        updateStatus(`å®¢æˆ· ${userId} å·²è¿æ¥`, 'connected');
    });

    // 2. ç›‘å¬è¿œç«¯ç”¨æˆ·(å®¢æˆ·)ç¦»å¼€
    aliRtcEngine.on('remoteUserOffLineNotify', (userId) => {
        updateStatus(`å®¢æˆ· ${userId} å·²æŒ‚æ–­`, 'idle');
        leaveCall();
    });

    // 3. ç›‘å¬å¹¶è®¢é˜…éŸ³é¢‘æµ (æœ€å…³é”®çš„ä¸€æ­¥ï¼šå¬åˆ°å®¢æˆ·å£°éŸ³)
    aliRtcEngine.on('remoteStreamAvailableNotify', (userId, streamType) => {
        console.log('æ”¶åˆ°æµ:', userId, streamType);
        // è®¢é˜…éŸ³é¢‘æµ
        aliRtcEngine.subscribe(userId, { audio: true, video: false }); // AI æ¥ç®¡é€šå¸¸åªéœ€è¦éŸ³é¢‘
    });

    // ---- æ ¸å¿ƒé€»è¾‘ B: åŠ¨ä½œå‡½æ•° ----

    async function startTakeover() {
        if (!authInfo.token || !authInfo.channel) {
            alert('é”™è¯¯ï¼šURL ä¸­ç¼ºå°‘å¿…è¦çš„é‰´æƒå‚æ•° (token/channelId)');
            return;
        }

        try {
            updateStatus('æ­£åœ¨å…¥ä¼š...', 'idle');

            // 1. åŠ å…¥é¢‘é“
            await aliRtcEngine.joinChannel(authInfo, authInfo.channel);
            
            // 2. å‘å¸ƒæœ¬åœ°éº¦å…‹é£ (è®©å®¢æˆ·å¬åˆ°å®¢æœå£°éŸ³)
            // å…ˆè·å–éº¦å…‹é£æƒé™
            await aliRtcEngine.enableLocalAudio(true); 
            // å‘å¸ƒ
            await aliRtcEngine.publish().catch(err => console.error("å‘å¸ƒå¤±è´¥", err));

            updateStatus('âœ… é€šè¯ä¸­ - å·²æ¥ç®¡', 'connected');
            toggleButtons(true);
            
            // å¯é€‰ï¼šåœ¨è¿™é‡Œæ’­æ”¾ä¸€ä¸ªâ€œå®â€çš„æç¤ºéŸ³

        } catch (error) {
            console.error(error);
            updateStatus(`å…¥ä¼šå¤±è´¥: ${error.message}`, 'error');
        }
    }

    async function leaveCall() {
        try {
            await aliRtcEngine.leaveChannel();
            updateStatus('å·²æŒ‚æ–­', 'idle');
            toggleButtons(false);
        } catch (error) {
            console.error(error);
        }
    }

    // ---- è¾…åŠ©å‡½æ•° ----
    function updateStatus(text, type) {
        const el = document.getElementById('status');
        el.innerText = text;
        el.className = `status-box status-${type} text-center`;
    }

    function toggleButtons(isCalling) {
        document.getElementById('btn-join').disabled = isCalling;
        document.getElementById('btn-leave').disabled = !isCalling;
    }
</script>
</body>
</html>