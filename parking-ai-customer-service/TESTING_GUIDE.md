# 真人接管功能测试指南

本文档提供真人接管功能的完整测试流程和场景说明。

## 测试准备

### 1. 环境检查

确保以下环境配置正确:

**后端配置** (`server/.env`):
```env
ALIBABA_CLOUD_ACCESS_KEY_ID=your_key_id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_key_secret
ALIBABA_CLOUD_REGION=cn-hangzhou  # 必须与 Agent 所在区域一致
AGENT_ID=your_agent_id
ALIBABA_CLOUD_RTC_APP_ID=your_rtc_app_id
ALIBABA_CLOUD_RTC_APP_KEY=your_rtc_app_key
PORT=3000
```

⚠️ **关键配置注意事项**:
1. `ALIBABA_CLOUD_REGION` 必须与阿里云 IMS 控制台中 Agent 所在区域一致
2. `RTC_APP_ID` 和 `RTC_APP_KEY` 必须同时配置
3. Agent ID 必须是已创建的有效 ID

### 2. 启动所有服务

#### 方式一: 使用一键启动脚本 (推荐)
```bash
./start-all.sh
```

#### 方式二: 手动分别启动
```bash
# 终端 1: 启动后端
cd server
npm start

# 终端 2: 启动用户端
npm run dev

# 终端 3: 启动客服端
cd agent-client
npm run dev
```

### 3. 验证服务状态

打开浏览器访问:
- 用户端: http://localhost:5173
- 客服端: http://localhost:5174
- 后端健康检查: http://localhost:3000/health (如果有)

---

## 测试场景

### 场景一: 用户主动转人工流程 (✅ 必测)

**目标**: 验证用户点击"转人工"按钮后的完整流程

#### 测试步骤:

1. **客服端准备**
   - 打开客服端 (http://localhost:5174)
   - 输入客服ID: `agent-001`
   - 输入客服昵称: `测试客服`
   - 点击"登录"按钮
   - 确认连接状态显示"已连接"
   - 确认客服状态显示"在线"

2. **用户端发起通话**
   - 打开用户端 (http://localhost:5173)
   - 点击"开始通话"按钮
   - 等待 AI 接通
   - 与 AI 进行 2-3 轮对话

3. **触发转人工**
   - 点击"转人工"按钮
   - 观察用户端显示:
     - ✅ "正在为您转接人工客服,请稍候..."
     - ✅ 或显示排队信息 (如有其他用户在排队)

4. **客服接听**
   - 观察客服端:
     - ✅ 会话列表中出现新会话
     - ✅ 显示用户ID、会话ID
     - ✅ 转人工原因显示为 "user_requested" 或类似文本
   - 点击"接入"按钮
   - 等待 RTC 连接建立

5. **验证通话状态**
   - **客服端**:
     - ✅ 显示"当前会话"面板
     - ✅ 展示完整的 AI 对话历史
     - ✅ RTC 状态显示 "joined"
     - ✅ 客服状态自动切换为"忙碌"
   - **用户端**:
     - ✅ AI 停止说话
     - ✅ 转人工状态消失
     - ✅ 能听到客服声音

6. **进行真人对话**
   - 用户和客服进行简短对话
   - 验证音频双向通畅

7. **挂断会话**
   - 客服端点击"挂断"按钮
   - **客服端验证**:
     - ✅ "当前会话"面板消失
     - ✅ 客服状态自动恢复为"在线"
   - **用户端验证**:
     - ✅ 通话结束
     - ✅ 界面恢复到初始状态

#### 预期结果:
- ✅ 整个流程无错误
- ✅ AI 对话历史完整传递给客服
- ✅ RTC 音频通话质量良好
- ✅ 状态流转正确

---

### 场景二: 关键词触发转人工 (✅ 必测)

**目标**: 验证用户说出关键词时自动触发转人工

#### 测试步骤:

1. **客服端准备** (同场景一)
   - 登录客服端并设置为"在线"状态

2. **用户端发起通话**
   - 打开用户端并开始与 AI 通话

3. **说出触发关键词**
   - 用户说话时明确说出以下关键词之一:
     - "转人工"
     - "人工客服"
     - "真人"
     - "投诉"
     - "人工"
   - ⚠️ 注意: 关键词必须在完整句子结束后才会触发 (等待 `isSentenceEnd` 标记)

4. **验证自动触发**
   - **用户端**:
     - ✅ 自动显示转人工状态
     - ✅ 转人工原因为 "keyword_detected"
   - **客服端**:
     - ✅ 收到新会话通知
     - ✅ 显示触发的关键词

5. **完成流程** (同场景一步骤 4-7)

#### 预期结果:
- ✅ 关键词检测准确
- ✅ 自动触发转人工无需手动点击
- ✅ 关键词信息正确传递给客服

---

### 场景三: AI 智能判断转人工 (✅ 必测)

**目标**: 验证 AI 主动建议转人工的流程

#### 测试步骤:

1. **配置 AI Agent**
   - 在阿里云 IMS 控制台配置 Agent
   - 设置在特定情况下发送自定义消息:
     ```json
     {
       "type": "transfer_to_human",
       "reason": "用户问题超出AI能力范围"
     }
     ```
   - 例如: 当用户连续 3 次询问 AI 无法回答的问题时触发

2. **客服端准备** (同场景一)

3. **触发 AI 判断**
   - 用户端开始通话
   - 故意提出 AI 无法回答的问题
   - 重复提问直到触发条件

4. **验证弹窗确认**
   - **用户端**:
     - ✅ 弹出确认对话框
     - ✅ 显示 AI 建议的原因
     - ✅ 提供"确认"和"取消"选项

5. **用户确认转人工**
   - 点击"确认"按钮
   - 后续流程同场景一

6. **测试拒绝转人工**
   - 重复步骤 3-4
   - 点击"取消"按钮
   - **验证**:
     - ✅ 继续与 AI 对话
     - ✅ 不触发转人工流程

#### 预期结果:
- ✅ AI 自定义消息正确触发
- ✅ 用户可以选择是否转人工
- ✅ 确认后流程正常完成

---

### 场景四: 多客服并发处理 (⚠️ 压力测试)

**目标**: 验证多个客服同时处理会话的能力

#### 测试步骤:

1. **启动多个客服**
   - 打开 2-3 个客服端浏览器窗口
   - 分别登录不同客服ID:
     - `agent-001`
     - `agent-002`
     - `agent-003`
   - 全部设置为"在线"状态

2. **发起多个转人工请求**
   - 打开 3-5 个用户端窗口
   - 同时发起 AI 通话
   - 几乎同时点击"转人工"按钮

3. **验证分配逻辑**
   - **后端日志**:
     - ✅ 查看会话分配算法 (轮询/随机)
     - ✅ 无重复分配
   - **客服端**:
     - ✅ 每个客服收到不同的会话
     - ✅ 接听后状态切换为"忙碌"
     - ✅ 忙碌客服不再收到新会话

4. **测试队列机制**
   - 所有客服接听会话后(状态为"忙碌")
   - 新用户请求转人工
   - **验证**:
     - ✅ 用户显示排队信息
     - ✅ 显示队列位置和预计等待时间
     - ✅ 有客服挂断后立即分配给排队用户

#### 预期结果:
- ✅ 支持至少 3-5 个并发会话
- ✅ 分配算法公平合理
- ✅ 队列机制正常工作

---

### 场景五: 异常场景处理 (⚠️ 稳定性测试)

**目标**: 验证各种异常情况的容错能力

#### 5.1 客服掉线

**步骤**:
1. 客服登录并接听会话
2. 通话进行中,强制关闭客服端浏览器或断网
3. **验证**:
   - ✅ 后端检测到客服断线
   - ✅ 用户端收到提示 (可选)
   - ✅ 会话从客服列表移除
   - ✅ 会话重新进入队列或结束

#### 5.2 用户挂断

**步骤**:
1. 用户请求转人工并被客服接听
2. 用户端点击"挂断"或关闭页面
3. **验证**:
   - ✅ 客服端收到会话结束通知
   - ✅ 客服状态自动恢复为"在线"
   - ✅ RTC 连接正常断开

#### 5.3 RTC 连接失败

**步骤**:
1. 客服接听会话
2. 故意配置错误的 RTC Token (修改后端代码测试)
3. **验证**:
   - ✅ 显示 RTC 错误信息
   - ✅ 客服端不会卡死
   - ✅ 可以重试或拒绝会话

#### 5.4 API 调用失败

**步骤**:
1. 暂停后端服务
2. 用户点击"转人工"
3. **验证**:
   - ✅ 显示友好的错误提示
   - ✅ 不影响 AI 通话
   - ✅ 用户可以重试

#### 5.5 会话超时

**步骤**:
1. 用户请求转人工
2. 客服不接听,等待 10 分钟 (默认超时时间)
3. **验证**:
   - ✅ 会话从队列中自动移除
   - ✅ 用户收到超时提示
   - ✅ 后端日志记录超时事件

---

## 性能指标

### 延迟指标
- WebSocket 连接建立: < 500ms
- 转人工请求响应: < 2s
- RTC 频道加入: < 3s
- 音频延迟: < 300ms

### 并发指标
- 支持并发会话数: ≥ 10
- 队列容量: ≥ 50
- 客服数量: ≥ 20

---

## 测试检查清单

### 功能完整性
- [ ] 用户主动转人工正常工作
- [ ] 关键词触发准确无误
- [ ] AI 智能判断流程完整
- [ ] 客服登录/登出正常
- [ ] 客服状态切换正确
- [ ] 会话接听/拒绝/挂断正常
- [ ] AI 对话历史完整传递
- [ ] RTC 音频通话清晰

### 状态管理
- [ ] 会话状态流转正确 (ai_talking → waiting_human → human_talking → ended)
- [ ] 客服状态流转正确 (online ⟷ busy)
- [ ] 队列状态实时更新
- [ ] 断线重连后状态恢复

### 错误处理
- [ ] 网络异常有友好提示
- [ ] API 失败不影响主流程
- [ ] RTC 错误可重试
- [ ] 客服掉线自动处理
- [ ] 超时机制正常工作

### 用户体验
- [ ] 界面响应及时
- [ ] 状态提示清晰
- [ ] 无明显卡顿
- [ ] 音频质量良好
- [ ] 错误信息易懂

---

## 常见问题排查

### 1. 转人工无反应

**可能原因**:
- 后端服务未启动
- WebSocket 连接失败
- 阿里云 API 配置错误

**排查方法**:
```bash
# 检查后端日志
tail -f server/server.log

# 检查网络请求
# 打开浏览器开发者工具 → Network 标签

# 验证 WebSocket 连接
# 打开浏览器开发者工具 → Console 标签
# 应该看到 "Socket 已连接" 消息
```

### 2. RTC 无法加入频道

**可能原因**:
- RTC Token 获取失败
- TakeoverAIAgentCall API 调用失败
- 区域配置不匹配

**排查方法**:
```bash
# 检查后端日志中的 API 响应
grep "TakeoverAIAgentCall" server/server.log

# 验证环境变量
cat server/.env | grep RTC
cat server/.env | grep REGION
```

### 3. 收不到新会话通知

**可能原因**:
- 客服未登录或状态为离线
- WebSocket 连接断开
- 所有客服都忙碌且队列已满

**排查方法**:
```bash
# 检查客服连接状态
# 在客服端控制台查看"系统事件"列表

# 检查后端 AgentStatusManager
# 在后端日志中搜索客服ID
grep "agent-001" server/server.log
```

---

## 停止服务

### 使用停止脚本
```bash
./stop-all.sh
```

### 手动停止
```bash
# 查找进程
lsof -i :3000  # 后端
lsof -i :5173  # 用户端
lsof -i :5174  # 客服端

# 停止进程
kill <PID>
```

---

## 测试报告模板

测试完成后,请填写以下报告:

```markdown
# 测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: XXX
**测试环境**: macOS / Windows / Linux

## 场景测试结果

- [ ] ✅/❌ 场景一: 用户主动转人工
- [ ] ✅/❌ 场景二: 关键词触发
- [ ] ✅/❌ 场景三: AI 智能判断
- [ ] ✅/❌ 场景四: 多客服并发
- [ ] ✅/❌ 场景五: 异常场景

## 发现的问题

| 编号 | 严重程度 | 问题描述 | 复现步骤 | 截图/日志 |
|------|---------|---------|---------|----------|
| 1    | 高/中/低 |         |         |          |

## 性能表现

- WebSocket 连接: XXXms
- 转人工响应: XXXms
- RTC 加入: XXXms
- 音频延迟: XXXms

## 总体评价

(优秀/良好/一般/较差)

## 改进建议

1. ...
2. ...
```

---

## 相关文档

- [CLAUDE.md](./CLAUDE.md) - 项目总览
- [README.md](./README.md) - 用户端使用说明
- [agent-client/README.md](./agent-client/README.md) - 客服端使用说明
- [CONFIG_GUIDE.md](./CONFIG_GUIDE.md) - 配置指南
