# Playwright 自动化测试用例

**创建时间**: 2026-01-18
**测试工具**: Playwright MCP
**测试范围**: 停车场 AI 智能客服系统

---

## 🎯 测试目标

验证以下核心功能：
1. 用户端 AI 通话功能
2. 客服端登录和状态管理
3. 用户主动转人工流程
4. 客服接听和语音通话
5. 关键词触发转人工（待实现）
6. 排队机制（待实现）

---

## 📋 测试用例清单

### 测试套件 1：环境验证

#### TC-001: 服务可用性检查
**优先级**: P0
**前置条件**:
- 所有服务已启动（后端、用户端、客服端）

**测试步骤**:
1. 访问用户端：`https://localhost:5173`
2. 验证页面加载成功
3. 验证页面标题包含"AI 智能客服"
4. 访问客服端：`https://localhost:5174`
5. 验证页面加载成功
6. 验证页面显示登录界面

**期望结果**:
- ✅ 用户端页面正常显示
- ✅ 客服端页面正常显示
- ✅ 无控制台错误

---

### 测试套件 2：用户端基础功能

#### TC-101: 用户端界面加载
**优先级**: P0
**前置条件**: 用户端服务运行中

**测试步骤**:
1. 打开用户端 `https://localhost:5173`
2. 检查页面元素：
   - "AI 智能客服" 标题
   - "开始通话" 按钮
   - "转人工" 按钮（可能隐藏）
   - 通话状态显示区域

**期望结果**:
- ✅ 所有核心 UI 元素正常显示
- ✅ 按钮可交互
- ✅ 初始状态为"未连接"

---

#### TC-102: 发起 AI 通话
**优先级**: P0
**前置条件**:
- 用户端页面已加载
- 后端服务正常运行
- 已配置阿里云凭证

**测试步骤**:
1. 点击"开始通话"按钮
2. 等待通话建立（最多 10 秒）
3. 观察通话状态变化
4. 检查 RTC 连接状态

**期望结果**:
- ✅ 按钮状态变为"通话中"
- ✅ 显示通话时长
- ✅ 显示 AI 客服应答
- ✅ 音频流建立成功

**验证点**:
- 控制台无错误
- WebSocket 连接成功
- RTC 频道加入成功
- 能听到 AI 语音

---

#### TC-103: 显示转人工按钮
**优先级**: P1
**前置条件**:
- AI 通话已建立

**测试步骤**:
1. 在通话中查找"转人工"按钮
2. 验证按钮可见性
3. 验证按钮可点击

**期望结果**:
- ✅ "转人工"按钮显示
- ✅ 按钮状态为可用（非禁用）

---

#### TC-104: 主动请求转人工
**优先级**: P0
**前置条件**:
- AI 通话已建立
- 至少一个客服在线

**测试步骤**:
1. 点击"转人工"按钮
2. 观察页面状态变化
3. 检查是否显示排队信息
4. 等待客服接听（最多 30 秒）

**期望结果**:
- ✅ 显示"转接中"或"排队中"状态
- ✅ 如果有排队，显示队列位置
- ✅ WebSocket 接收到转人工确认消息
- ✅ 后端 API 调用成功

**验证点**:
- 检查控制台网络请求
- 验证 `/api/request-human-takeover` 返回成功
- 验证 WebSocket 消息推送

---

#### TC-105: 挂断通话
**优先级**: P0
**前置条件**:
- 通话已建立（AI 或人工）

**测试步骤**:
1. 点击"挂断"按钮
2. 观察状态变化
3. 验证资源释放

**期望结果**:
- ✅ 通话状态变为"已结束"
- ✅ 按钮恢复为"开始通话"
- ✅ RTC 连接关闭
- ✅ WebSocket 发送挂断消息

---

### 测试套件 3：客服端基础功能

#### TC-201: 客服端登录
**优先级**: P0
**前置条件**:
- 客服端页面已加载
- WebSocket 服务运行中

**测试步骤**:
1. 打开客服端 `https://localhost:5174`
2. 在"客服 ID"输入框输入：`agent-001`
3. 在"客服名称"输入框输入：`测试客服`
4. 点击"登录"按钮
5. 观察登录状态

**期望结果**:
- ✅ 显示"已连接"状态
- ✅ 客服状态变为"在线"
- ✅ WebSocket 连接成功
- ✅ 后端日志记录客服登录

**验证点**:
- 控制台显示 `Agent agent-001 logged in successfully`
- WebSocket 连接状态为"已连接"

---

#### TC-202: 客服状态切换
**优先级**: P1
**前置条件**:
- 客服已登录

**测试步骤**:
1. 点击"设为忙碌"按钮
2. 验证状态变化
3. 点击"设为在线"按钮
4. 验证状态恢复

**期望结果**:
- ✅ 状态正确切换（在线 ⟷ 忙碌）
- ✅ 忙碌时不接收新会话
- ✅ WebSocket 同步状态变化

---

#### TC-203: 接收会话通知
**优先级**: P0
**前置条件**:
- 客服已登录且状态为"在线"
- 用户端已请求转人工

**测试步骤**:
1. 保持客服端在"在线"状态
2. 用户端发起转人工请求
3. 观察客服端界面变化
4. 检查等待队列

**期望结果**:
- ✅ 客服端显示新会话通知
- ✅ 等待队列中出现会话条目
- ✅ 显示用户 ID 和等待时长
- ✅ "接听"和"拒绝"按钮可用

**验证点**:
- WebSocket 接收到 `new-session` 事件
- 会话数据包含：sessionId, userId, 等待时间

---

#### TC-204: 接听会话
**优先级**: P0
**前置条件**:
- 客服端有等待会话
- 客服状态为"在线"

**测试步骤**:
1. 点击会话的"接听"按钮
2. 等待 RTC 连接建立（最多 10 秒）
3. 观察通话状态
4. 检查音频流

**期望结果**:
- ✅ 会话从队列移除
- ✅ 客服状态自动变为"忙碌"
- ✅ 显示当前通话面板
- ✅ RTC 频道加入成功
- ✅ 能与用户进行语音通话

**验证点**:
- API `/api/agent-accept-call` 返回成功
- 返回数据包含：rtcToken, channelId, rtcUserId
- WebSocket 接收到 `takeover-success` 事件
- 用户端收到转人工成功通知

---

#### TC-205: 查看会话历史
**优先级**: P2
**前置条件**:
- 客服已接听会话

**测试步骤**:
1. 在当前通话面板中查看"会话历史"区域
2. 验证显示 AI 对话记录
3. 检查记录格式

**期望结果**:
- ✅ 显示用户与 AI 的历史对话
- ✅ 对话按时间排序
- ✅ 显示角色（用户/AI）

---

#### TC-206: 客服挂断会话
**优先级**: P0
**前置条件**:
- 客服正在通话中

**测试步骤**:
1. 点击"挂断"按钮
2. 观察状态变化
3. 验证资源释放

**期望结果**:
- ✅ 通话面板关闭
- ✅ 客服状态恢复为"在线"
- ✅ RTC 连接关闭
- ✅ WebSocket 发送会话结束消息
- ✅ 用户端收到会话结束通知

---

#### TC-207: 拒绝会话
**优先级**: P2
**前置条件**:
- 客服端有等待会话
- 客服状态为"在线"

**测试步骤**:
1. 点击会话的"拒绝"按钮
2. 观察队列变化
3. 检查会话重新分配

**期望结果**:
- ✅ 会话从当前客服队列移除
- ✅ 客服状态保持"在线"
- ✅ 会话返回公共队列或分配给其他客服
- ✅ 用户端收到等待提示

---

### 测试套件 4：端到端流程测试

#### TC-301: 完整转人工流程
**优先级**: P0
**前置条件**:
- 用户端、客服端、后端服务均正常
- 至少一个客服在线

**测试步骤**:
1. **用户端操作**:
   - 打开用户端
   - 点击"开始通话"
   - 等待 AI 连接成功
   - 点击"转人工"按钮
   - 观察转接状态

2. **客服端操作**:
   - 打开客服端
   - 登录（agent-001 / 测试客服）
   - 等待会话通知
   - 点击"接听"按钮
   - 等待 RTC 连接

3. **验证通话**:
   - 验证双方音频连接
   - 保持通话 10 秒
   - 客服点击"挂断"

4. **验证结束**:
   - 验证用户端收到结束通知
   - 验证双方资源释放

**期望结果**:
- ✅ 用户成功发起 AI 通话
- ✅ 用户成功请求转人工
- ✅ 客服端收到会话通知
- ✅ 客服成功接听
- ✅ 双方 RTC 连接建立
- ✅ 音频流正常
- ✅ 挂断后资源正确释放

**验证点**:
- 用户端 AI 连接断开后加入人工频道
- 客服端加入同一个 RTC 频道
- channelId 以 `HUMAN_` 开头
- 双方使用不同的 userId

---

#### TC-302: 无客服在线场景
**优先级**: P1
**前置条件**:
- 用户端正常
- 后端正常
- **无客服在线**

**测试步骤**:
1. 用户端发起 AI 通话
2. 点击"转人工"
3. 观察提示信息

**期望结果**:
- ✅ 显示"暂无客服在线"或"排队等待"
- ✅ 显示预计等待时间
- ✅ 用户可选择继续等待或返回 AI

---

#### TC-303: 多用户并发转人工
**优先级**: P2
**前置条件**:
- 后端正常
- 仅一个客服在线

**测试步骤**:
1. 打开两个用户端窗口（Tab1, Tab2）
2. Tab1 发起转人工
3. Tab2 立即发起转人工
4. 观察排队顺序
5. 客服接听 Tab1
6. 验证 Tab2 仍在队列

**期望结果**:
- ✅ Tab1 排队位置：1
- ✅ Tab2 排队位置：2
- ✅ Tab1 被客服接听
- ✅ Tab2 收到位置更新通知（位置变为 1）
- ✅ FIFO 队列顺序正确

---

### 测试套件 5：异常场景测试

#### TC-401: 用户中途挂断
**优先级**: P2
**前置条件**:
- 用户已请求转人工
- 客服尚未接听

**测试步骤**:
1. 用户发起转人工
2. 在客服接听前，用户点击"挂断"
3. 观察客服端队列变化

**期望结果**:
- ✅ 会话从客服端队列移除
- ✅ 后端清理会话数据
- ✅ 无残留会话

---

#### TC-402: 客服掉线处理
**优先级**: P2
**前置条件**:
- 客服正在通话中

**测试步骤**:
1. 建立用户-客服通话
2. 关闭客服端浏览器标签页
3. 观察用户端反应

**期望结果**:
- ✅ 用户端收到"客服已离线"通知
- ✅ 用户端 RTC 连接关闭
- ✅ 后端检测到客服掉线
- ✅ 会话状态更新为"ended"

---

#### TC-403: 网络中断恢复
**优先级**: P2
**前置条件**:
- 用户端通话中

**测试步骤**:
1. 建立 AI 通话
2. 模拟网络中断（开发者工具 → Offline）
3. 等待 5 秒
4. 恢复网络（Online）
5. 观察重连行为

**期望结果**:
- ✅ 检测到断线
- ✅ 显示"连接中断"提示
- ✅ 自动尝试重连
- ✅ 恢复后重新建立连接

---

#### TC-404: RTC 连接失败
**优先级**: P2
**前置条件**:
- 后端配置错误的 RTC Token（测试用）

**测试步骤**:
1. 用户发起通话
2. 观察错误处理

**期望结果**:
- ✅ 显示友好的错误提示
- ✅ 不崩溃或卡死
- ✅ 可以重试
- ✅ 控制台记录错误详情

---

### 测试套件 6：性能测试

#### TC-501: 通话建立延迟
**优先级**: P2
**前置条件**: 正常网络环境

**测试步骤**:
1. 记录点击"开始通话"的时间戳
2. 记录 RTC 连接成功的时间戳
3. 计算延迟

**期望结果**:
- ✅ AI 通话建立延迟 < 3 秒
- ✅ 转人工 RTC 连接延迟 < 5 秒

---

#### TC-502: WebSocket 消息延迟
**优先级**: P2
**前置条件**: WebSocket 连接正常

**测试步骤**:
1. 用户发起转人工
2. 记录请求发送时间
3. 记录客服端收到通知时间
4. 计算延迟

**期望结果**:
- ✅ WebSocket 消息推送延迟 < 500ms
- ✅ 无消息丢失

---

#### TC-503: 长时间通话稳定性
**优先级**: P2
**前置条件**:
- 用户-客服通话已建立

**测试步骤**:
1. 建立用户-客服通话
2. 保持通话 30 分钟
3. 每 5 分钟检查一次状态
4. 验证通话质量

**期望结果**:
- ✅ 30 分钟内无掉线
- ✅ 音频质量稳定
- ✅ 无内存泄漏
- ✅ CPU 占用正常

---

## 🛠️ Playwright 测试脚本框架

### 基础测试脚本结构

```javascript
// test-suite-basic.spec.js
const { test, expect } = require('@playwright/test');

test.describe('基础功能测试', () => {

  test('TC-001: 服务可用性检查', async ({ page }) => {
    // 用户端测试
    await page.goto('https://localhost:5173');
    await expect(page).toHaveTitle(/AI 智能客服/);

    // 客服端测试
    await page.goto('https://localhost:5174');
    await expect(page.locator('text=客服登录')).toBeVisible();
  });

  test('TC-101: 用户端界面加载', async ({ page }) => {
    await page.goto('https://localhost:5173');

    // 验证核心元素
    await expect(page.locator('text=AI 智能客服')).toBeVisible();
    await expect(page.locator('button:has-text("开始通话")')).toBeVisible();
  });

  // ... 更多测试用例
});
```

---

## 📊 测试执行计划

### 阶段 1：基础验证（今天）
- [ ] TC-001: 服务可用性检查
- [ ] TC-101: 用户端界面加载
- [ ] TC-201: 客服端登录

### 阶段 2：核心功能（本周）
- [ ] TC-102: 发起 AI 通话
- [ ] TC-104: 主动请求转人工
- [ ] TC-204: 接听会话
- [ ] TC-301: 完整转人工流程

### 阶段 3：高级功能（下周）
- [ ] TC-302: 无客服在线场景
- [ ] TC-303: 多用户并发转人工
- [ ] TC-205: 查看会话历史
- [ ] TC-207: 拒绝会话

### 阶段 4：异常场景（下下周）
- [ ] TC-401 至 TC-404: 所有异常场景

### 阶段 5：性能测试（月底）
- [ ] TC-501 至 TC-503: 所有性能测试

---

## 📝 测试记录模板

### 测试执行记录

| 用例编号 | 用例名称 | 执行时间 | 执行结果 | 失败原因 | 截图/日志 |
|---------|---------|---------|---------|---------|-----------|
| TC-001 | 服务可用性检查 | 2026-01-18 19:00 | ⏳ 待测试 | - | - |
| TC-101 | 用户端界面加载 | - | ⏳ 待测试 | - | - |
| ... | ... | ... | ... | ... | ... |

---

## 🎯 成功标准

### 通过标准
- ✅ 所有 P0 用例通过率 100%
- ✅ 所有 P1 用例通过率 ≥ 95%
- ✅ 所有 P2 用例通过率 ≥ 90%
- ✅ 无阻塞性缺陷
- ✅ 所有已知缺陷已记录到 log.md

### 失败处理
1. 记录失败截图和控制台日志
2. 分析失败原因（代码 bug / 测试用例问题）
3. 提交 bug 或修正测试用例
4. 重新测试

---

**文档创建**: 2026-01-18
**维护者**: AI 全栈架构师
**版本**: v1.0
