# ✅ 测试检查清单

## 📋 准备工作

### 1. 验证文件修改

```bash
# 检查用户端配置
cat vite.config.ts | grep "host:"

# 检查客服端配置  
cat agent-client/vite.config.ts | grep "host:"

# 检查脚本权限
ls -lh *.sh | grep rwx
```

**预期结果**：
- ✅ 两个配置文件都包含 `host: '0.0.0.0'`
- ✅ 所有 .sh 文件都有执行权限 (rwxr-xr-x)

---

## 🚀 第一步：启动服务

### 方式 A：使用菜单（推荐）

```bash
./menu.sh
```

操作：
1. 选择 `1` - 启动所有服务
2. 等待启动完成
3. 看到"✓ 所有服务启动成功"

### 方式 B：使用命令行

```bash
./restart-all.sh
```

**验证**：
```bash
./check-status.sh
```

**预期结果**：
```
✓ 后端服务 (端口 3000) - 运行中
✓ 用户端 (端口 5173) - 运行中  
✓ 客服端 (端口 5174) - 运行中
```

---

## 🌐 第二步：验证网络访问

### 查看本机 IP

```bash
./test-network.sh
```

**记录信息**：
- 本机 IP：________________
- 用户端：http://本机IP:5173
- 客服端：http://本机IP:5174

### 测试访问

**本机浏览器**：
- [ ] http://localhost:5173 能打开
- [ ] http://localhost:5174 能打开

**手机/其他设备**（可选）：
- [ ] http://本机IP:5173 能打开
- [ ] http://本机IP:5174 能打开

---

## 👨‍💼 第三步：客服端登录

### 打开客服端

浏览器访问：http://localhost:5174

### 登录操作

1. **输入客服 ID**：`agent-001`
2. **输入客服昵称**：`客服小张`
3. **点击"连接"**

**验证**：
- [ ] 状态显示"在线" (online)
- [ ] WebSocket 连接成功
- [ ] 没有错误提示

**浏览器控制台应该看到**：
```
[WebSocket] Connected
[WebSocket] Login success: { agentId: "agent-001", ... }
```

---

## 👤 第四步：用户端发起通话

### 打开用户端

浏览器访问：http://localhost:5173

### 发起通话

1. **点击"开始通话"按钮**
2. **允许麦克风权限**（浏览器提示）
3. **等待连接 AI**

**验证**：
- [ ] AI 说话（欢迎语）
- [ ] 能看到 AI 的文字
- [ ] 麦克风图标显示正常

### 触发转人工

**说出关键词**："转人工"

**验证**：
- [ ] 看到"正在转接人工客服"提示
- [ ] 显示等待状态
- [ ] 可能显示排队位置

---

## 🎧 第五步：客服端接听

### 查看新会话

**客服端应该显示**：
- [ ] "待接入会话"列表出现新会话
- [ ] 显示会话 ID
- [ ] 显示用户 ID

### 点击接听

**点击"接听"按钮**

**验证接听流程**：
1. [ ] 按钮变为"正在接入..."
2. [ ] 看到"🎙️ 通话中"面板
3. [ ] RTC 状态：⏳ starting → ✅ 已连接
4. [ ] 通话时长开始计时：00:00 → 00:01 → 00:02...
5. [ ] 麦克风按钮可用："🎤 静音"

**浏览器控制台应该看到**：
```
[RTC] Joining independent channel: { channelId: "...", rtcUserId: "..." }
[RTC] Publishing microphone audio...
[RTC] Successfully joined channel and published audio
```

---

## 🎤 第六步：验证双向音频

### 测试客服说话 → 用户听

**客服端操作**：
1. 对着麦克风说话："你好，我是客服"

**用户端验证**：
- [ ] 能听到客服的声音
- [ ] 声音清晰，没有杂音

### 测试用户说话 → 客服听

**用户端操作**：
1. 对着麦克风说话："你好，我需要帮助"

**客服端验证**：
- [ ] 能听到用户的声音
- [ ] 声音清晰，没有杂音

### 测试麦克风静音

**客服端操作**：
1. 点击"🎤 静音"按钮
2. 按钮变为"🔇 取消静音"（橙色）
3. 对着麦克风说话

**用户端验证**：
- [ ] 听不到客服说话（静音生效）

**客服端操作**：
1. 再次点击"🔇 取消静音"按钮
2. 按钮变回"🎤 静音"（蓝色）
3. 对着麦克风说话

**用户端验证**：
- [ ] 又能听到客服说话（取消静音生效）

---

## 📜 第七步：验证对话历史

**客服端"对话历史"区域应该显示**：
- [ ] AI 与用户的对话记录
- [ ] 用户消息（蓝色背景）
- [ ] AI 消息（灰色背景）
- [ ] 消息时间顺序正确

---

## 📞 第八步：挂断测试

### 客服端主动挂断

**客服端操作**：
1. 点击"📞 挂断"按钮

**验证**：
- [ ] 客服端："通话中"面板消失
- [ ] 客服端：状态变回"在线"
- [ ] 用户端：看到"通话已结束"提示

### 用户端主动挂断

**重复步骤 4-5 建立新通话**

**用户端操作**：
1. 点击"结束通话"按钮

**验证**：
- [ ] 用户端：通话结束
- [ ] 客服端：收到会话结束通知
- [ ] 客服端：状态变回"在线"

---

## 🔍 调试检查（如果有问题）

### 查看后端日志

```bash
./view-logs.sh
# 选择 "1 - 后端服务日志"
```

**查找关键信息**：
- 转人工请求：`POST /api/request-human-takeover`
- 客服接听：`POST /api/agent-accept-call`
- RTC Token 生成
- 错误信息

### 查看浏览器控制台

**客服端控制台**：
- 查找 `[RTC]` 开头的日志
- 查找错误（红色）

**用户端控制台**：
- 查找 AI 通话引擎日志
- 查找 WebSocket 日志

### 常见问题排查

**问题 1：客服端 RTC 状态一直 "starting"**
- 检查后端 Token 是否生成成功
- 检查控制台是否有错误
- 检查麦克风权限是否授予

**问题 2：用户听不到客服**
- 检查客服端是否调用了 `publish()`
- 检查客服端控制台：应该有 "Publishing microphone audio"
- 检查客服端麦克风权限

**问题 3：客服听不到用户**
- 检查用户端麦克风权限
- 检查用户端是否正常发布音频
- 检查客服端是否订阅了用户

**问题 4：局域网无法访问**
- 运行 `./restart-all.sh` 确保配置生效
- 检查防火墙设置
- 确认设备在同一网络

---

## ✅ 测试通过标准

### 必须通过（P0）

- [x] 服务启动成功（3个服务都运行）
- [x] 客服端登录成功
- [x] 用户端发起通话成功
- [x] 转人工请求成功
- [x] 客服端接听成功
- [x] RTC 连接成功（状态显示"已连接"）
- [x] 双向音频通话（客服和用户互相听得到）
- [x] 麦克风静音功能正常

### 应该通过（P1）

- [ ] 通话时长计时正常
- [ ] 对话历史展示正常
- [ ] 挂断功能正常
- [ ] 状态变化正确

### 可选通过（P2）

- [ ] 局域网访问正常
- [ ] 手机访问正常
- [ ] 多客服场景正常
- [ ] 日志记录完整

---

## 📊 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 服务启动 | ⬜ 通过 / ⬜ 失败 | |
| 客服登录 | ⬜ 通过 / ⬜ 失败 | |
| 用户通话 | ⬜ 通过 / ⬜ 失败 | |
| 转人工 | ⬜ 通过 / ⬜ 失败 | |
| 客服接听 | ⬜ 通过 / ⬜ 失败 | |
| RTC 连接 | ⬜ 通过 / ⬜ 失败 | |
| 客服→用户音频 | ⬜ 通过 / ⬜ 失败 | |
| 用户→客服音频 | ⬜ 通过 / ⬜ 失败 | |
| 麦克风静音 | ⬜ 通过 / ⬜ 失败 | |
| 挂断功能 | ⬜ 通过 / ⬜ 失败 | |

---

## 🎯 下一步

### 测试通过后

1. **记录测试结果**
2. **提交代码**（如果使用 Git）
3. **准备生产部署**

### 测试失败后

1. **查看日志**：`./view-logs.sh`
2. **查看控制台**：浏览器开发者工具
3. **参考文档**：`AGENT_RTC_FIX.md`、`NETWORK_ACCESS.md`
4. **重启服务**：`./restart-all.sh`

---

**开始测试吧！祝一切顺利！🚀**
